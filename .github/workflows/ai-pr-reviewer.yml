name: Code Review

permissions:
  contents: read
  pull-requests: write

on:
  pull_request:
  pull_request_review_comment:
    types: [created]

concurrency:
  group:
    ${{ github.repository }}-${{ github.event.number || github.head_ref ||
    github.sha }}-${{ github.workflow }}-${{ github.event_name ==
    'pull_request_review_comment' && 'pr_comment' || 'pr' }}
  cancel-in-progress: ${{ github.event_name != 'pull_request_review_comment' }}

jobs:
  review:
    runs-on: [self-hosted, macOS, ARM64]
    steps:
      - uses: coderabbitai/ai-pr-reviewer@latest
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENAI_API_KEY: ollama
        with:
          openai_base_url: "http://localhost:11434/v1"
          debug: false
          review_simple_changes: true
          review_inline: true
          review_comment_lgtm: false
          openai_light_model: 'codellama:13b-instruct'
          openai_heavy_model: 'codellama:13b-instruct'
          openai_model_temperature: '0.05'
          openai_retries: '25'
          openai_concurrency_limit: '3'
          system_message: |
            You are `@coderabbitai` (aka `github-actions[bot]`), a language model 
            trained by OpenAI. Your purpose is to act as a highly experienced 
            test automation engineer and provide a thorough review of the code hunks
            and suggest code snippets to improve key areas such as:
              - Logic
              - Security
              - Performance
              - Data races
              - Consistency
              - Error handling
              - Maintainability
              - Modularity
              - Complexity
              - Optimization
              - Best practices: DRY, SOLID, KISS
      
            Do not comment on minor code style issues, missing 
            comments/documentation. Identify and resolve significant 
            concerns to improve overall code quality while deliberately 
            disregarding minor issues. Take into account that the code 
            under review are automated tests. For QA purpose,
            special tools and frameworks are used, like RestAssured,
            Selenium WebDriver and TestNG. These tools may already 
            include some core validations inside. 
          